stages:
  - default
  - build_push
  - deploy_staging

variables:
  KUBE_CONFIG: "YXBpVmVyc2lvbjogdjEKY2x1c3RlcnM6Ci0gY2x1c3RlcjoKICAgIGNlcnRpZmljYXRlLWF1dGhvcml0eS1kYXRhOiBMUzB0TFMxQ1JVZEpUaUJEUlZKVVNVWkpRMEZVUlMwdExTMHRDazFKU1VNMWVrTkRRV01yWjBGM1NVSkJaMGxDUVVSQlRrSm5hM0ZvYTJsSE9YY3dRa0ZSYzBaQlJFRldUVkpOZDBWUldVUldVVkZFUlhkd2NtUlhTbXdLWTIwMWJHUkhWbnBOUWpSWVJGUkpkMDFVUVhwTlJFbDNUV3BuTUU1V2IxaEVWRTEzVFZSQmVVOUVTWGROYW1jd1RsWnZkMFpVUlZSTlFrVkhRVEZWUlFwQmVFMUxZVE5XYVZwWVNuVmFXRkpzWTNwRFEwRlRTWGRFVVZsS1MyOWFTV2gyWTA1QlVVVkNRbEZCUkdkblJWQkJSRU5EUVZGdlEyZG5SVUpCVFhWVUNucFZVMEl3Ukd4U1MyOWFjbXdyU1dGS1NIZFhUVzVxZUhSelozcG9PVmhzVm5WaE5URlBZWGxJVm0xRFQzUjROU3RIYWpZeFptdHNOVEpJUzFsME1Ha0tiQ3RzVEZGMWJIRlFTbmN3V21kS2JHUlBVa1JRY0VWWFFrNHdkVFIyZUROdk0zTjZPV3gyVTFOUVRqSjBOVlZKYTFwcWN6SjJhekZqVTNwV1RXMW1PUXBTYUV0SU0zUnNXbVprTm5KWWFGQkVSa3R4ZG1ONk15OW9NRmc0ZDFWVWNtUXljSHBGZDJKUFUxbE5WV2RDZGpFMFYweHhUbmRKTVRGUWNuWmlWV3BPQ2tGdFRUUnhXa05QYTJGc2ExaFJRVzVFVEhKVGQzaHRSbEoxUXk5d2RtYzFLMVJxU2twa1UyZG1ZVVZVT1dZMFNGazFNbWxDWm1wSGFrZHZMMGRtVnpBS1owUm1OazFyVlc5VU9EQjZRVzR2ZEcwdmFYbFZNeXN3YWxCeVdrUlhXbTl3Y1c5NGNscHBkVk53VW5GM1MxaDNkUzl2VkVKMmRHcEtVWFJGT1c5TGNnbzFiMHRHY21oVmIzRk1VVFprVEZWNllYWk5RMEYzUlVGQllVNURUVVZCZDBSbldVUldVakJRUVZGSUwwSkJVVVJCWjB0clRVRTRSMEV4VldSRmQwVkNDaTkzVVVaTlFVMUNRV1k0ZDBoUldVUldVakJQUWtKWlJVWkdlbU5xUVVJd1ExQmxNa0ZhT1dkbWJ6UmhkMWhQUzNORmFEZE5RVEJIUTFOeFIxTkpZak1LUkZGRlFrTjNWVUZCTkVsQ1FWRkRTR2xYTUVoaFQzWTVabmhqT1RoQ2FsQkdhbmxXZDBsSmFscE5ZWEJ2U25WTE0yOUtMM0JyTlU5cFVsSndWakp6Vndvd1EwbFFNRVJHWkUxMWNYbHZVMGcyYURaS1VUZGthMjVvWmpkVVpqWm9VWFF3ZGpsV1RFeERVRm8zTmxwc1FsWmxNbVk0UlUxRU5rUlVibnAyVkhsa0NuTndSamgxYkd0WWMxb3djRzFuVGpOM04wOUpkblZ0U0ZaME1rVkNZbXQxUW5GeWFHeHFTMFJZTlUxMmNrdFBRMmx1ZGt0WVJVWkpSMDVwVGt4U2JrMEthbFJZYld0aU0wWjZiRmxsVEZVMWRrWktSekJSU0VOb09UQnlPVGRRYVZOd1drcFpSV3d2Y1d4RmVpODFjVkl4YURoeFJtdE9VekpKT0dWYVVrRm1Sd292ZWpKaVVUTXpaVGt2V1dSc04wMHpjek4xYlZGT1IyaGhXVnBHWTFOcllVOVVOSGgzZEVWNWNFMTBWMkZpU1cxeWJuRkdiR05GZVdOSGMyMHZUelV5Q2xBMFdqUkZMMGx6WkhkQ2JHMDVWRXRCZFVoRlNITTVkWGROZG5kS1NubG1WWEpyZGdvdExTMHRMVVZPUkNCRFJWSlVTVVpKUTBGVVJTMHRMUzB0Q2c9PQogICAgc2VydmVyOiBodHRwczovL2t1YmUtY2x1c3Rlci5kb3J3aW5pYS5jb206NjQ0MwogIG5hbWU6IGt1YmVybmV0ZXMKY29udGV4dHM6Ci0gY29udGV4dDoKICAgIGNsdXN0ZXI6IGt1YmVybmV0ZXMKICAgIHVzZXI6IGt1YmVybmV0ZXMtYWRtaW4KICBuYW1lOiBrdWJlcm5ldGVzLWFkbWluQGt1YmVybmV0ZXMKY3VycmVudC1jb250ZXh0OiBrdWJlcm5ldGVzLWFkbWluQGt1YmVybmV0ZXMKa2luZDogQ29uZmlnCnByZWZlcmVuY2VzOiB7fQp1c2VyczoKLSBuYW1lOiBrdWJlcm5ldGVzLWFkbWluCiAgdXNlcjoKICAgIGNsaWVudC1jZXJ0aWZpY2F0ZS1kYXRhOiBMUzB0TFMxQ1JVZEpUaUJEUlZKVVNVWkpRMEZVUlMwdExTMHRDazFKU1VSRmVrTkRRV1oxWjBGM1NVSkJaMGxKU0ZRck0zUXpibFp0U2sxM1JGRlpTa3R2V2tsb2RtTk9RVkZGVEVKUlFYZEdWRVZVVFVKRlIwRXhWVVVLUVhoTlMyRXpWbWxhV0VwMVdsaFNiR042UVdWR2R6QjVUVVJGZDAxNlFYbE5SRWswVGtSV1lVWjNNSGxOVkVWM1RYcEJlVTFFU1RST1ZFSmhUVVJSZUFwR2VrRldRbWRPVmtKQmIxUkViazQxWXpOU2JHSlVjSFJaV0U0d1dsaEtlazFTYTNkR2QxbEVWbEZSUkVWNFFuSmtWMHBzWTIwMWJHUkhWbnBNVjBackNtSlhiSFZOU1VsQ1NXcEJUa0puYTNGb2EybEhPWGN3UWtGUlJVWkJRVTlEUVZFNFFVMUpTVUpEWjB0RFFWRkZRWFptWTJkVlRHeDZUWGgyVVhkd0t6SUtTRkEzZWxnNVRERlJWMmtyYkdsbVp6Rm5ibmROUVhOQldYVlFNemR4YVdjelVEaFFXRkZPVFZwNVZuVmpNalJLZG0wMVFXeG1UV0ZPVVRGbGJucHNVQXB6TVVoaVlUZEdZbThyUVUxUmRuRjFhRVZETm1kSVJUVkhhMnAyU1Vwc05GZEhjV05RWm1KT2IwVTNUekJXUkdzM2RrbDFhU3QyZDFkalVIUllSVXd5Q2xaRlZqZGlTa1JQVDBSUFpEWXhNMkZaWmpWeVdsVjVabXRFWlRSYVdWQXlUalZpZEhaeVdsSkxMeTg1UWxwbFl6RkNZemQyV25sNlZXZ3JkWFZaTkdRS1dtUk5lSEUwY1daNk0zRk9aVXh1Y2xWNWMzQTBWbGRKVWtac1dtdHhVMEV2ZDNONWMxTlNSMjg0YVVFek9VNVpOQ3RCWTBSRlVuSkxXVU5ETVVObEx3cDVZMGd5T0d0eGVubHhReTlsYlRaa2RqZEZRVnBOUlhSSVJESXhUbE5VY1RGMEt6RkdTVWR2VFUxelJGRjRXR04xVkRoWmExbE9ZMlJYU25BMlZ6TTJDa1p1ZURsbWQwbEVRVkZCUW04d1ozZFNha0ZQUW1kT1ZraFJPRUpCWmpoRlFrRk5RMEpoUVhkRmQxbEVWbEl3YkVKQmQzZERaMWxKUzNkWlFrSlJWVWdLUVhkSmQwaDNXVVJXVWpCcVFrSm5kMFp2UVZWWVRubE5RVWhSU1RrM1dVSnVNa0lyYW1oeVFtTTBjWGRUU0hOM1JGRlpTa3R2V2tsb2RtTk9RVkZGVEFwQ1VVRkVaMmRGUWtGSFExTTRORlpaWlRSbU9HaFdZWE54YVVGM2FpOUVkMHhtZGtSbmNFRm1NM052SzJOQ1NtNVRWVkJOY1ZFNGRtNW9RazE2Ulhwc0NtODFNRlpMVldNMVdHZE5WbGw0YmtkQ2R6ZDBSVzlIZDJZdlpWWXJhak01VFdwNVdYZFZTMUZwUlRkS1NsVTNSWE56UVRabWJrNTFXakl2ZFdkbWJFVUtkRWhUVDFWWGRpOHdSVFp0VW00clowZEhSVXRaYWpGck5ISktjWGhuVEU4NVUxTTRVbEZtYVRWUVUzUjNVblZ6ZUd4cloySmljVTAzV1V0eGVVMVVkUXB0V1VkdU1HUTJiVGgxWjFWUVFYQkxiQzlOWkhCS2MxZHdRbTFPVWxwblNUZHpNVXBaYVRCalRGY3JXazVRZVRjMFMwdEtVbVpUUkhZeFlUVnZNMGxMQ21GR1FqSTRhaXRTWVZwMlVGcDJiSGN4WlRGSVJuRlRLMGRyUWk4cmRYbEtjR050VVZSaWFYZFJSa1k0VjJGSFFsSnZRbkEwWjBSR1p6SnpkV1owWVRVS01UUjRiMmszU2tZdmJEbFNOMVl4VUcxc1MxSjNTMWxyU1hJMVZreHNWVDBLTFMwdExTMUZUa1FnUTBWU1ZFbEdTVU5CVkVVdExTMHRMUW89CiAgICBjbGllbnQta2V5LWRhdGE6IExTMHRMUzFDUlVkSlRpQlNVMEVnVUZKSlZrRlVSU0JMUlZrdExTMHRMUXBOU1VsRmNFRkpRa0ZCUzBOQlVVVkJkbVpqWjFWTWJIcE5lSFpSZDNBck1raFFOM3BZT1V3eFVWZHBLMnhwWm1jeFoyNTNUVUZ6UVZsMVVETTNjV2xuQ2pOUU9GQllVVTVOV25sV2RXTXlORXAyYlRWQmJHWk5ZVTVSTVdWdWVteFFjekZJWW1FM1JtSnZLMEZOVVhaeGRXaEZRelpuU0VVMVIydHFka2xLYkRRS1YwZHhZMUJtWWs1dlJUZFBNRlpFYXpkMlNYVnBLM1ozVjJOUWRGaEZUREpXUlZZM1lrcEVUMDlFVDJRMk1UTmhXV1kxY2xwVmVXWnJSR1UwV2xsUU1ncE9OV0owZG5KYVVrc3ZMemxDV21Wak1VSmpOM1phZVhwVmFDdDFkVmswWkZwa1RYaHhOSEZtZWpOeFRtVk1ibkpWZVhOd05GWlhTVkpHYkZwcmNWTkJDaTkzYzNselUxSkhiemhwUVRNNVRsazBLMEZqUkVWU2NrdFpRME14UTJVdmVXTklNamhyY1hwNWNVTXZaVzAyWkhZM1JVRmFUVVYwU0VReU1VNVRWSEVLTVhRck1VWkpSMjlOVFhORVVYaFlZM1ZVT0ZscldVNWpaRmRLY0RaWE16Wkdibmc1Wm5kSlJFRlJRVUpCYjBsQ1FVTk1iVFppWjB4TGNVSkZVbmR1VEFwSlJVZGFhMmQxVlVSa01sUnhhR2xoWjFKUGVWSmlMems1V0dNeE0xWkxja0p6YzNwNldsaFJVMnhTVmtzd1RHNHZPRUpQVERJeVpHVmlOSFpyTm1ZM0NtUnhjRU54ZFdKU1kyb3pZM0F3VVZSSVRXUk9kMVJhYVVaNFV5dFBOMnR2YlZaVVpGZGFSMFUySzJrNVRXZERRazVXTmpGbWJHNVZOSEJqVEdsWGRTOEtTR1JWUkRSNFdtbFZTa1pCTkc4elp6ZzBUek52TDBjM2NqQkdiWFZzT1ZveVFreE9ORFp3TVUwek1WUm5UbTl6YTJKT1dqVXdTMDUwTlVsYUx5OTRjd3AxVVRWTVJIcExkRXBMYUVkcFkyOXVNMjkwUkU5VVJuVnZRMlZpWlRSeFkwSlNVSG8xVEM5TVNUTkZaMlJrUkVwTWFuVlFWVTFZVFRSVE5TOXhWRmx5Q21Sc1kxUkVORTFGY0VwS1NqbERURmxMVFVKSFdHeFdjMUk1ZGxsM05sTm5XRGRXU1RSS1VGaHRjbWM0WVV0RFlqUlZiMmRUVldWU1JYRjFZV0pQWnprS1FXWkNjWEkxUlVObldVVkJNM1V4UjNsT1ZtRmhSa0ppZUdZNVNESXpTR1ZrV1ZOYVVUVXlSbVZ0VUd3MVRUWXhUVE15VFU5VlNYcFRNU3RJYTNad01BcFBNMUJ6V0VSWGFFRlpSMnRuSzJoeWVsUjBLMVpDVTFoM2VFVnBOM0owVDBORFJtZDNTWFZ1Tm5CTmRXWlhWMVJFTDFCWGVrOTVabFJUUkZsaVVYZDJDamt5YVdoM1NXMVJUa0p0SzNrd1ltOVVjSFF2ZEhOUlZUVk9lWEl3VUROQ09GRkxWekZtYmtOcVEyUm5Ra3RRUmxkVFNsTlBTbXREWjFsRlFUSnBXRFlLUkVadmFrTnVhMlJUZFRsWEwwd3dNMFpXVG1WekwyMW9Zak14UnpOTWJHSjZhbTByTm1GdFJrZE9WM1JoV1VJMFNsSTROVkpDVVhaSU9WVnNjVmhhUmdwRGEwUkNWR2RaZVVac1VuSk9hVkl4UVdoU1Z6WmFjemh6TjFsTVkxSTNNMkZUU0d4Vk5GWXlNbTVPVGtzNGFIbHJOMVJpT1V0c1pGTTFWbXN4Ym1kQ0NtUk1ZM1pVZWtsbU16RlZWR0UzZW5walVpOU5OVFp1TTFWcVJqQlNlbnB0Y2pGaFYzWmtZME5uV1VWQmNuWm1kemROVWpST2VFOU1Wa2haZGtGbkx6TUtiVXRzUVZkbksxTnhhVTF4VmpGSVpXRjBSMHBqTkN0QlJIaExiSEZFYVc1aVpIQnZhekU0VFZKa1FuQlFXbUkwZEZwaFUyRnZMMWhLWVZkWWF6SlRlZ3AwUkVoMVlraEhkMnMyTlRsbFRFb3liMHhwZW5sU1pWaFhUVkZGTW0xSlRXRTVWbFo2TTJGd1JtaDBNalJ5YkN0eUsxQm5ZelpUYlN0YVNYZ3dUa00yQ201a01UUlpaVEp6VVhKRVRUZG9aRlZXT0dSWFdGWkZRMmRaUlVGMmFXeEhka2xtUTJKbWJTODRSR1ZOTkRSd2NIWjJlRXN6UzFwd09VazRTRTgxWlZZS1JVMU9SSGxrY0U1UVMxaG1iMk13YzJKdFpUSmxjMDFDYUZWVkwzSkhXamx5YmpsbFVXODJhVVZPWTAxRmEyeGlaV3BIVTNoa1ltUTFiVm94ZFU5c1pRcHJUbGhOVnpZNVNFOVJkM3B3UlhZMmJsRnRWMmc0VFhadldtbGpTekY1TTBsRVFXcFlSM280V0dGdFF6UllURE16TkM5NVFtRjNhUzlTU2tKSk1uaFRDbEl4ZHpZd1ZXTkRaMWxCY2tOUVVuQlBlazlpYlhkVVZFWkhkV3BSUWpacWFUTjBNMkV5VFcwM1dtSnRSakF2YjFJMloySlJOMVkwWldaVk1IVXZkM1lLWWxaTVdXOUJaelJFVkhCSVJub3dhbTlSZW5kdk1HbEdUVXhqTVN0Rk5GUktNM1ZDVlhGRFpETnlWVGxtUmpSNk1rdHhTR3RyYlU5MFUzZFJXVGhoVndwMGNVVlFUM0IyVVdGQ2NFMHhVRGxMUlRaSlFqQnVRMHhIZW1WSmVFWXhWblJZYlZoUVJFTjZURmh1YVU5d1pGTTBlbTlXZVVFOVBRb3RMUzB0TFVW"

default:
  image: docker:latest
  before_script:
    - docker info
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY

build_push:
  stage: build_push
  script:
    - docker build -t gitlab.dorwinia.com:5050/homelab/docker-homepage .
    - docker push gitlab.dorwinia.com:5050/homelab/docker-homepage

install_kubectl:
  stage: deploy_staging
  script:
    - curl -LO "https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl"
    - chmod +x ./kubectl
    - sudo mv ./kubectl /usr/local/bin/kubectl
    - kubectl version --client
    - echo -n $KUBE_CONFIG | base64 -d > ./config
    - cat ./config

deploy_staging:
  stage: deploy_staging
  script:
    - kubectl rollout restart deployment/homepage-stag --namespace=homepage-stag
  environment:
    name: staging
    url: http://kube-worker-1.dorwinia.com:30002
  only:
    - master
